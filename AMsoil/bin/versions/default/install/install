#!/bin/bash

###
#       @author: msune, Carolina
#	@organization: i2CAT
#	@project: Ofelia FP7
#	@description: install module 
###

#Constants
SRC_DIR=/opt/ofelia/AMsoil/
APACHE_USER="www-data"

#Inform user
printHeader "info#" "Using default install module..."

##Main routing

#Install dependencies
printHeader ">" "Installing dependencies through apt-get..."

source $CURRENT_DIRECTORY/lib/dependencies || error "Cannot import dependencies file" $NO_RESCUE
/usr/bin/apt-get update || error "Could not update repositories (apt-get). Do you have connectivity?" $NO_RESCUE 
/usr/bin/apt-get -y install $DEBIAN_DEPENDENCIES || error "Could not install dependencies (apt-get)" $NO_RESCUE 
source $CURRENT_DIRECTORY/lib/pypelib || error "Cannot import PyPElib installation file" $NO_RESCUE

#apt-get start apache => stop it
#/usr/sbin/service apache2 stop
#apt-get start nginx => stop it
/usr/sbin/service nginx stop

printHeader ">" "Installing remaining dependencies through pip..."
warning "pip may randomly fail on the installation. This is a common error of pip; simply try again installation."
/usr/bin/pip $PIP_DEPENDENCIES || error "Could not install dependencies (pip)" $NO_RESCUE

#printHeader ">" "Enabling macro and ssl module in apache2..."
#Enabling Apache mods
#/usr/sbin/a2enmod macro || warn "Could not enable macro module" "; maybe already enabled?"
#/usr/sbin/a2enmod ssl || warn "Could not enable ssl module" "; maybe already enabled?"
#/usr/sbin/a2enmod wsgi || warn "Could not enable wsgi module" "; maybe already enabled?"

#Build ssl certs
#TODO: add stuff for certificates in this file
#source $CURRENT_DIRECTORY/lib/ssl

#Create symbolic links
#printHeader ">" "Creating symbolic links for the vhost files in apache sites-enabled folder..." 

#if [ ! -f /etc/apache2/conf.d/vhost-macros.conf ]; then
#ln -sf $SRC_DIR/src/config/vt_manager/common/apache/vhost-macros.conf /etc/apache2/conf.d/vhost-macros.conf || error "Cannot create vhost-macros symbolic link"
#fi
#ln -sf $SRC_DIR/src/config/vt_manager/apache/vhost-vt.conf /etc/apache2/sites-available/vt_manager.conf || error "Cannot create symbolic link in /etc/apache2/sites-available/ for the expedient vhost file..."
#ln -sf /etc/apache2/sites-available/vt_manager.conf /etc/apache2/sites-enabled/ || error "Cannot create symbolic link in /etc/apache2/sites-enabled to enable vhost..."

#Create application folder for error log
mkdir -p /opt/ofelia/AMsoil/log/
#And symlink it
mkdir -p /var/log/ofelia/
ln -s /opt/ofelia/AMsoil/log /var/log/ofelia/virtualisation

#Change permissions of the code 
#printHeader ">" "Setting correct file permissions..."
#chown -f $APACHE_USER $SRC_DIR/src/python/vt_manager/controller/policies/utils/log

#Module settings 
source $CURRENT_DIRECTORY/lib/settings

#Django database
#source $CURRENT_DIRECTORY/lib/django-db

