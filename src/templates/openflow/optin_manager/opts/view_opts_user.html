{% extends "base.html" %}

{% block scripts %}
<style>
  td {
    width: 800px;
  }
  th {
    width: 800px;
  }
</style>

<script type="text/javascript">

var highlighted_row = null;

function clicked(tr_id){
	if (highlighted_row==null) {
		highlighted_row = document.getElementById(tr_id)
		highlighted_row.setAttribute("class","highlighted")
	} else if (highlighted_row.getAttribute("id")==tr_id) {
		highlighted_row.setAttribute("class","non-highlighted")
		highlighted_row = null
	} else {
		highlighted_row.setAttribute("class","non-highlighted")
		highlighted_row = document.getElementById(tr_id)
		highlighted_row.setAttribute("class","highlighted")
	}
		
}

function prev_sibling(obj){
	var sibling = obj.previousSibling;
	while (sibling && sibling.nodeType != 1) {
		sibling = sibling.previousSibling;
	}
	if (sibling) {
		return sibling
	}
	else {
		return null
	}
}

function next_sibling(obj){
	var sibling = obj.nextSibling;
	while (sibling && sibling.nodeType != 1) {
		sibling = sibling.nextSibling;
	}
	if (sibling) {
		return sibling
	}
	else {
		return null
	}
}

function update_table(table,base) {
	var row_count = table.rows.length
	for(var i=1; i<row_count; i++) {
		var row = table.rows[i]
		hidden_elem = row.getElementsByTagName("input")[0]
		hidden_elem.setAttribute("value",base+i)
	}
}

function updown(ud){
	if (highlighted_row == null) {
		return
	} 
	tr_elem = highlighted_row
	if (ud==1) {
		prev_tr_elem = prev_sibling(tr_elem)
		if (prev_tr_elem && prev_tr_elem.getElementsByTagName("input").length > 0) {
		
			tmp_html = prev_tr_elem.innerHTML
			prev_tr_elem.innerHTML = tr_elem.innerHTML
			tr_elem.innerHTML = tmp_html
			
			prev_hidden_elem = prev_tr_elem.getElementsByTagName("input")[0]
			hidden_elem = tr_elem.getElementsByTagName("input")[0]
			prev_priority = prev_hidden_elem.getAttribute("value")
			priority = hidden_elem.getAttribute("value")
			prev_hidden_elem.setAttribute("value",priority)
			hidden_elem.setAttribute("value",prev_priority)
			
			to_be_copied = ["id","class","onClick"]
			for (i=0; i<to_be_copied.length; i++){
				key = to_be_copied[i]
				prev_key = prev_tr_elem.getAttribute(key)
				this_key = tr_elem.getAttribute(key)
				prev_tr_elem.setAttribute(key,this_key)
				tr_elem.setAttribute(key,prev_key)
			}
			
			highlighted_row = prev_tr_elem
		}
	}
	if (ud==-1) {
		next_tr_elem = next_sibling(tr_elem)
		if (next_tr_elem && next_tr_elem.getElementsByTagName("input").length > 0) {
		
			tmp_html = next_tr_elem.innerHTML
			next_tr_elem.innerHTML = tr_elem.innerHTML
			tr_elem.innerHTML = tmp_html
			
			next_hidden_elem = next_tr_elem.getElementsByTagName("input")[0]
			hidden_elem = tr_elem.getElementsByTagName("input")[0]
			next_priority = next_hidden_elem.getAttribute("value")
			priority = hidden_elem.getAttribute("value")
			next_hidden_elem.setAttribute("value",priority)
			hidden_elem.setAttribute("value",next_priority)
			
			to_be_copied = ["id","class","onClick"]
			for (i=0; i<to_be_copied.length; i++){
				key = to_be_copied[i]
				prev_key = next_tr_elem.getAttribute(key)
				this_key = tr_elem.getAttribute(key)
				next_tr_elem.setAttribute(key,this_key)
				tr_elem.setAttribute(key,prev_key)
			}
			
			highlighted_row = next_tr_elem
		}
	}
}

function nicestrict() {
	if (highlighted_row == null) {
		return
	} 
	tr_elem = highlighted_row
	selected_priority = parseInt(tr_elem.getElementsByTagName("input")[0].getAttribute("value"))
	old_table = tr_elem.parentNode
	var row_count = old_table.rows.length
	for(var i=0; i<row_count; i++) {
    	var row = old_table.rows[i]
        if (row.getAttribute("id")==highlighted_row.getAttribute("id")) {
        	var to_be_deleted_index = i
			break
        }
	}
	if (selected_priority<1000) {
    	new_table = document.getElementsByTagName("table")[2]
    	new_base_priority = 1000
    	old_base_priority = 0
    } else {
    	new_table = document.getElementsByTagName("table")[1] 
    	new_base_priority = 0
    	old_base_priority = 1000
    }
    
	new_row = new_table.insertRow(1)
	new_row.innerHTML = tr_elem.innerHTML
	to_be_copied = ["id","class","onClick"]
	for (i=0; i<to_be_copied.length; i++){
		key = to_be_copied[i]
		new_row.setAttribute(key,tr_elem.getAttribute(key))
	}
	old_table.deleteRow(to_be_deleted_index)
		
	// now try to find the previous optin and set priority accordingly
	next_tr_elem = next_sibling(new_row)
	if (next_tr_elem && next_tr_elem.getElementsByTagName("input").length > 0) {
		next_priority = next_tr_elem.getElementsByTagName("input")[0].getAttribute("value")
		new_row.getElementsByTagName("input")[0].setAttribute("value",parseInt(next_priority)+1)
	} else {
		new_row.getElementsByTagName("input")[0].setAttribute("value",new_base_priority+1)
	}
	update_table(old_table,old_base_priority)
	highlighted_row = new_row
}

</script>
{% endblock %}

{% block content %}
<div class="main">
    <h2>Experiments Opted In by {{user.username}}</h2>
		<div align="right">
			<a href="/dashboard">Dashboard</a><br/>
		</div>

		<div>
		{% for error in error_msg %}
			<p><font color="red">{{error}}</font></p>
		{% endfor %}

		</div>

		<div>	
		<center>
		<button type=button onClick="updown(1)">Up</button>
		<button type=button onClick="updown(-1)">Down</button>
		<button type=button onClick="nicestrict()">Switch</button>  	
		<form name="input" action="/opts/update_opts" method="post">
		</center>
			{% csrf_token %}
			<h2> flexible opt-ins</h2>
			<table class="formtable" >
				<tr><th><center>Experiment</center></th></tr>
				{% for opt in nice_opts %}
				<tr id="tr_{{opt.id}}" onClick="clicked('tr_{{opt.id}}')" class="non_highlight">
					<td><center>
						<input type="hidden" name="p_{{opt.id}}" value="{{opt.priority}}"/>
						<a href="/opts/experiment/{{opt.experiment.id}}">
						{{opt.experiment.project_name}}:{{opt.experiment.slice_name}}
						</a>
					</center></td>
				</tr>
				{% endfor %}
			</table>
			<h2> strict opt-ins</h2>
			<table class="formtable" >
				<tr><th><center>Experiment</center></th></tr>
				{% for opt in strict_opts %}
				<tr id="tr_{{opt.id}}">
					<td><center>
						<input type="hidden" name="p_{{opt.id}}" value="{{opt.priority}}"/>
						<a href="/opts/experiment/{{opt.experiment.id}}">
						{{opt.experiment.project_name}}:{{opt.experiment.slice_name}}
						</a>
					</center></td>
				</tr>
				{% endfor %}
			</table>
			<center>
					<td><input type="submit" value="Update"/></td>
			</center>
		</form> 
		</div>

</div>
{% endblock content %}
