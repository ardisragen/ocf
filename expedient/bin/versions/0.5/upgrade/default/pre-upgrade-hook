#!/bin/bash

###
#       @author:lbergesio, CarolinaFernandez
#       @organization: i2CAT
#       @project: Ofelia FP7
#       @description: pre-upgrade-hook module  
###

#inform user
printHeader "info#" "Using specific 0.5 pre-upgrade-hook module..."

#Check for OFELIA installation
OFELIA="none"

local TMP_PATH=$PWD

print "Shutting down apache2..."
/usr/sbin/service apache2 stop

while [ $OFELIA != "yes" ] && [ $OFELIA != "no" ] && [ $OFELIA != 1 ] && [ $OFELIA != 0 ]
    do
        echo "Is this an official OFELIA island installation (yes/no):"
        read OFELIA
        if [ $OFELIA == yes ]; then
            OFELIA=1
        elif [ $OFELIA == no ]; then
            OFELIA=0
        else
            echo "Not a valid option. Please answer yes/no"
        fi
    done


print "Configuring GIT repository for GitHub..."

# Comment every line if not already commented
sed -i '/^#/! s/^/#/g' .git/config

# Add 'core' section
if [ -z `git config --get-regexp "core"` ]; then
    git config --add core.repositoryformatversion 0
    git config --add core.filemode true
    git config --add core.bare false
    git config --add core.logallrefupdates true
fi

if [ -z `git config --get-regexp "remote.origin"` ]; then
    # Add 'remote' repository
    git config --add remote.fetch "+refs/heads/*:refs/remotes/origin/*"
    if [[ $OFELIA == 1 ]]; then
        # R/W access for OFELIA developers
        git config --add remote.url "git@github.com:fp7-ofelia/ocf.git" 
    else
        git config --add remote.url "git://github.com/fp7-ofelia/ocf.git" 
    fi
    git config --rename-section remote 'remote "origin"'
fi

if [ -z `git config --get-regexp "ofelia.stable"` ]; then
    # Add 'ofelia.stable' branch
    git config --add branch.ofelia.stable.remote "origin"
    git config --add branch.ofelia.stable.merge "refs/heads/ofelia.stable"
fi

if [[ $OFELIA == 1 ]]; then
    if [ -z `git config --get-regexp "ofelia.development"` ]; then
        # Add 'ofelia.development' branch
        git config --add branch.ofelia.development.remote "origin"
        git config --add branch.ofelia.development.merge "refs/heads/ofelia.development"
    fi
fi

cd $TMP_PATH
