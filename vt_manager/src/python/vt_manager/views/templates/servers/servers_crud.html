{% extends "servers/servers_base.html" %}
{% load accessDict %}
{% block pagehead %}<h1>Add/Update virtualized server:</h1>{% endblock pagehead %}


{% block head %}

{% endblock %}
{% block scripts %}

<script type="text/javascript">
      $(function() {
        $('#ifacetable tbody').formset({
          prefix: '{{ ifaceformset.prefix }}',
          addText: 'Add Interface',
          deleteText: '',
          added: adding,
          addCssClass: 'buttoncss',
        });
      })
</script>
<script type="text/javascript">
    $(document).ready(function() {

   	{%if server%} 
    $("#submacbutton").click(function() {
        $.fancybox({'href': '{% url subscribeEthernetRanges server.id %}'});
    });
   
    $("#subipbutton").click(function() {
        $.fancybox({'href': '{% url subscribeIp4Ranges server.id %}'});
    });
	{% endif%}

});
</script>

<script language="javascript">

function adding(row){
    $(row).find('#rowDelete').remove();
}
</script>

<script>
    function updateVMstatus(){
        //$.getJSON("../../vt_plugin/vms_status/"+{{slice.id}}, function(data){
        $.getJSON("../../"+{{server.id}}+"/vms_status", function(data){
           $.each(data.status, function(index,value){
                    $("#td_vm"+index).replaceWith("<td id = td_vm"+index +" >"+ value +" </td>");
                    updateVMparams(data,index);
                }
           );
           var vms_table = document.getElementById('table_vms_list');
           $.each($("#table_vms_list tr"), function(tr_index, tr_table){
                var vmIdValue = tr_table.id.substring(5);
                if (tr_table.id != 'table_vms_list_header'){
                    var vmIdValue = tr_table.id.substring(5);
                    if (!data.status[vmIdValue]) {
                            $("#tr_vm"+vmIdValue).remove();
                    }
                }
            }
           );
        });
    }

   function updateVMparams(data,index){
        $("#td_vm_actions"+index).children().replaceWith(data.actions[index]);
       // $("#td_vm_ip"+index).children().replaceWith("<div>"+ data.ips[index]+"</div>");               
    } 
</script>
<script>
    var timer = setInterval(function(){
    updateVMstatus(); 
    },3000);
</script>
<script>
    function handleVMaction(serverId,vmId,action){
        $.getJSON("../../"+serverId+"/virtual_machines/"+vmId+"/"+action);  
        updateVMstatus();                                                     
    }
</script>


{% endblock %}
{% block content %}


<div class="main">

    <form id="serverAndIfaceForms" method="post" action="" autocomplete="off">{% csrf_token %}

        <div>
			<h2>General parameters</h2>
			<h3>Parameters</h3>
			{% if serverForm.errors %}
				<table>
				{%for field in serverForm %}
					{% if field.errors %}
                		<tr><th colspan ="2" class="fielderror">{{field.errors}}</th></tr>
					{% endif %}
				{% endfor %}
				</table>
            {% endif %}
       		<table class="formtable">
				{% if field.errors %} 
                	<tr><th colspan ="2">{{field.errors}}</th></tr>
				{% endif %} 
		    	<tr><td style="text-align:center;font-weight:bold">UUID:</td><td>{{ server.uuid }}</td></tr>
        		{% for field in serverForm %}
                    {% if field.errors %}                             
                            <tr class="fielderror" ><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {% else %}	
	                    	<tr><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
					{%endif%}
        		{% endfor %}
        	</table>
	
        </div>
	
		<div>
			<h2>Networking parameters</h2>
			<h3>Mgmt interface parameters</h3>
			{% if mgmtIfaceForm.errors %}
				<table>
                	{%for field in mgmtIfaceForm %}
						{% if field.errors %}
                		<tr><th colspan ="2" class="fielderror">{{field.errors}}</th></tr>
            			{% endif %}
            		{% endfor %}
				</table>
            {% endif %}
			<table id="mgmtifacetable" class="formtable">
				{% for field in mgmtIfaceForm %}
                    {% if field.errors %}
                            <tr class="fielderror" ><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {% else %}      
							<tr><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {%endif%}
				{% endfor %}
			</table>
		</div>	

		{% include "servers/servers_dataIfaces.html" %}


		{% if server %}
		<div>
            <h3>Suscribed Ethernet Ranges</h3>
			<table class="formtable">
				{%if server.getSubscribedMacRangesNoGlobal %}
				<tr>
				<td style="width: 200px;">Range Name:</td>
				<td>
					{% for macRange in server.getSubscribedMacRanges %}
						<a href="{% url showMacRange macRange.id %}">{{macRange.name}}</a>
						{% if not forloop.last %},{% endif%}
					{%endfor%}
						<input id="submacbutton" type="button" value="Subscribe" >
				</td>
				{% else %}
				<tr><td colspan=2>Click on <input id="submacbutton" type="button" value="Subscribe"> to add a new Ethernet range. If not a global range will be used</td></tr>
				{% endif %}
            </table>
		</div>
		<div>
            <h3>Suscribed IPv4 Ranges</h3>
			<table class="formtable">
                {%if server.getSubscribedIp4RangesNoGlobal %}
                <tr>
				<td style="width: 200px;">Range Name:</td>
				<td>
					{% for ipRange in server.getSubscribedIp4Ranges %}
						<a href="{% url showIp4Range ipRange.id %}">{{ipRange.name}}</a>
						{% if not forloop.last %},{% endif%}
					{%endfor%}
						<input id="subipbutton" type="button" value="Subscribe">
				</td>
                {% else %}
                <tr><td colspan=2>Click on <input id="subipbutton" type="button" value="Subscribe"> to add a new IPv4 range. If not a global range will be used</td></tr>
                {% endif %}
            </table>
		</div>
		{% endif %}

        <div class="center" style="margin-top : 30px;">
            <input type="submit" value="Save" /> |
            {% if server %}
            <a href="{% url delete_server server.id %}">Delete</a> |
            {% endif %}
            <a href="{% url dashboard %}">Dashboard</a>
        </div>
    </form>


	<div> 
   		{% if server %}
			{% with server.getChildObject as server %} 
    		<h1>VMs in {{ server.name }}</h1>
    		{% if not server.vms.all %}
        		{{ server.name }} has no VMs at the moment
    		{% else %}    
    			<table class="blue">
        	<tr id="table_vms_list_header">
            <th> Name</th>
            <th> Memory</th>
            <th> OS Type</th>
            <th> OS Dist</th>
            <th> OS Version</th>
            <th> Project</th>
            <th> Slice</th>
            <th> Status</th>
            <th> Actions </th>
        	</tr>
	        {% for vm in server.vms.all %}
	          <tr class = "{% cycle 'odd' 'even' %}">
	            <td><a href="{% url action_vm server.id vm.id "list"%}">{{ vm.name }}</a></td>
	            <td> {{vm.memory}}</td>
	            <td> {{vm.operatingSystemType }}</td>
	            <td> {{vm.operatingSystemDistribution }}</td>
	            <td> {{vm.operatingSystemVersion }}</td>
	            <td> <span title = "uuid: {{vmProjects|dictKeyLookup:vm.projectName}}">{{vm.projectName }}</span></td>
	            <td> <span title = "uuid: {{vmSlices|dictKeyLookup:vm.sliceName}}">{{vm.sliceName }}</span></td>
	            <td id = td_vm{{vm.id}}> {{vm.state }}</td>
	            <td id = td_vm_actions{{vm.id}}>
					<div>
					{% if vm.state == "running" %}
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'stop')">Stop</a> |
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'reboot')">Reboot</a>
                    {% endif %}
                    {% if  vm.state == "created (stopped)"%}
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'start')">Start</a> |
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'delete')">Delete</a>
                    {% endif %}
                    {% if vm.state == "stopped"%}
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'start')">Start</a> |
                        <a href="JavaScript:void(0)" onclick="handleVMaction({{server.id}},{{vm.id}},'delete')">Delete</a>
                    {% endif %}
                    {% if vm.state|slice:"-3:" == '...'  or vm.state == 'on queue'%}
                        <img src={% url img_media 'loading.gif'%} align="absmiddle">
                    {% endif %}
					</div>
	                <!--{% if vm.state == "running" %}
	                <a href="{% url action_vm server.id vm.id "stop" %}">Stop</a> | <a href="{% url action_vm server.id vm.id "reboot"%}">Reboot</a>
	                {% endif %}
	                {% if vm.state == "stopped" %}
	                <a href="{% url action_vm server.id vm.id "start"%}">Start</a> | <a href="{% url action_vm server.id vm.id "delete"%}">Delete</a>
	                {% endif %}
	                {% if vm.state == "created (stopped)" %}
	                <a href="{% url action_vm server.id vm.id "start"%}">Start</a> | <a href="{% url action_vm server.id vm.id "delete"%}">Delete</a>
	                {% endif %}
	                {% if vm.state == "failed" %}
	                <a href="{% url action_vm server.id vm.id "check_status" %}">Check status</a> 
	                {% endif %}-->
	
	            </td>
	        </tr>
	       {% endfor %}
	    	 </table>   
     		{% endif %}
			{% endwith %}
     	{% endif %}
	</div>

</div>
{% endblock content %}

