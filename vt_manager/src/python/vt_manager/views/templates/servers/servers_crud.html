{% extends "servers/servers_base.html" %}
{% block pagehead %}<h1>Add/Update virtualized server:</h1>{% endblock pagehead %}


{% block head %}

{% endblock %}
{% block scripts %}

<script type="text/javascript">
      $(function() {
        $('#ifacetable tbody').formset({
          prefix: '{{ ifaceformset.prefix }}',
          addText: 'Add Interface',
          deleteText: '',
          added: adding,
          addCssClass: 'buttoncss',
        });
      })
</script>
<script type="text/javascript">
    $(document).ready(function() {

   	{%if server%} 
    $("#submacbutton").click(function() {
        $.fancybox({'href': '{% url subscribeEthernetRanges server.id %}'});
    });
   
    $("#subipbutton").click(function() {
        $.fancybox({'href': '{% url subscribeIp4Ranges server.id %}'});
    });
	{% endif%}

});
</script>

<script language="javascript">

function adding(row){
    $(row).find('#rowDelete').remove();
}
</script>

<script>

	function createVMtable(){
         $(function () {
                   alert("length 0");                                    
         });
	}

    function updateVMstatus(){
        //$.getJSON("../../vt_plugin/vms_status/"+{{slice.id}}, function(data){
        $.getJSON("../../"+{{server.id}}+"/vms_status", function(data){
           $.each(data.status, function(index,value){
					if($("#td_vm"+index).length==0){
						//alert("hola");
					}
					else{
                    	$("#td_vm"+index).replaceWith("<td id = td_vm"+index +" >"+ value +" </td>");
                    	updateVMparams(data,index);
					}
                }
           );
           var vms_table = document.getElementById('table_vms_list');
           $.each($("#table_vms_list tr"), function(tr_index, tr_table){
                //var vmIdValue = tr_table.id.substring(5);
                if (tr_table.id != 'table_vms_list_header'){
                    var vmIdValue = tr_table.id.substring(5);
                    if (!data.status[vmIdValue]) {
                            $("#tr_vm"+vmIdValue).remove();
                    }
                }
            }
           );
		  if ($("#table_vms_list tr").length == 1){
				//$("#table_vms_list").remove()
				$("#div_vms").replaceWith("<div id = div_vms>{{ server.name }} has no VMs at the moment</div>");
			}
        });
    }

   function updateVMparams(data,index){
        $("#td_vm_actions"+index).children().replaceWith(data.actions[index]);
       // $("#td_vm_ip"+index).children().replaceWith("<div>"+ data.ips[index]+"</div>");               
    } 
</script>
<script>
    var timer = setInterval(function(){
	if ($("#table_vms_list tr").length != 0 ){
    	updateVMstatus(); }
	else{
		createVMtable();
	}
    },3000);
</script>
<script>
    function handleVMaction(serverId,vmId,action){
        $.getJSON("../../"+serverId+"/virtual_machines/"+vmId+"/"+action);  
        updateVMstatus();                                                     
    }
</script>


{% endblock %}
{% block content %}


<div class="main">

    <form id="serverAndIfaceForms" method="post" action="" autocomplete="off">{% csrf_token %}

        <div>
			<h2>General parameters</h2>
			<h3>Parameters</h3>
			{% if serverForm.errors %}
				<table>
				{%for field in serverForm %}
					{% if field.errors %}
                		<tr><th colspan ="2" class="fielderror">{{field.errors}}</th></tr>
					{% endif %}
				{% endfor %}
				</table>
            {% endif %}
       		<table class="formtable">
				{% if field.errors %} 
                	<tr><th colspan ="2">{{field.errors}}</th></tr>
				{% endif %} 
		    	<tr><td style="text-align:center;font-weight:bold">UUID:</td><td>{{ server.uuid }}</td></tr>
        		{% for field in serverForm %}
                    {% if field.errors %}                             
                            <tr class="fielderror" ><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {% else %}	
	                    	<tr><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
					{%endif%}
        		{% endfor %}
        	</table>
	
        </div>
	
		<div>
			<h2>Networking parameters</h2>
			<h3>Mgmt interface parameters</h3>
			{% if mgmtIfaceForm.errors %}
				<table>
                	{%for field in mgmtIfaceForm %}
						{% if field.errors %}
                		<tr><th colspan ="2" class="fielderror">{{field.errors}}</th></tr>
            			{% endif %}
            		{% endfor %}
				</table>
            {% endif %}
			<table id="mgmtifacetable" class="formtable">
				{% for field in mgmtIfaceForm %}
                    {% if field.errors %}
                            <tr class="fielderror" ><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {% else %}      
							<tr><th> {{ field.label_tag }}:</th><td> {{ field }}</td></tr>
                    {%endif%}
				{% endfor %}
			</table>
		</div>	

		{% include "servers/servers_dataIfaces.html" %}


		{% if server %}
		<div>
            <h3>Suscribed Ethernet Ranges</h3>
			<table class="formtable">
				{%if server.getSubscribedMacRangesNoGlobal %}
				<tr>
				<td style="width: 200px;">Range Name:</td>
				<td>
					{% for macRange in server.getSubscribedMacRanges %}
						<a href="{% url showMacRange macRange.id %}">{{macRange.name}}</a>
						{% if not forloop.last %},{% endif%}
					{%endfor%}
						<input id="submacbutton" type="button" value="Subscribe" >
				</td>
				{% else %}
				<tr><td colspan=2>Click on <input id="submacbutton" type="button" value="Subscribe"> to add a new Ethernet range. If not a global range will be used</td></tr>
				{% endif %}
            </table>
		</div>
		<div>
            <h3>Suscribed IPv4 Ranges</h3>
			<table class="formtable">
                {%if server.getSubscribedIp4RangesNoGlobal %}
                <tr>
				<td style="width: 200px;">Range Name:</td>
				<td>
					{% for ipRange in server.getSubscribedIp4Ranges %}
						<a href="{% url showIp4Range ipRange.id %}">{{ipRange.name}}</a>
						{% if not forloop.last %},{% endif%}
					{%endfor%}
						<input id="subipbutton" type="button" value="Subscribe">
				</td>
                {% else %}
                <tr><td colspan=2>Click on <input id="subipbutton" type="button" value="Subscribe"> to add a new IPv4 range. If not a global range will be used</td></tr>
                {% endif %}
            </table>
		</div>
		{% endif %}

        <div class="center" style="margin-top : 30px;">
            <input type="submit" value="Save" /> |
            {% if server %}
            <a href="{% url delete_server server.id %}">Delete</a> |
            {% endif %}
            <a href="{% url dashboard %}">Dashboard</a>
        </div>
    </form>


	<div>
		{% include "servers/servers_vms_include.html" %} 
	</div>

</div>
{% endblock content %}

