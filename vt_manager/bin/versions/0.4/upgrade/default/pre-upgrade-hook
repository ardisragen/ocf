#!/bin/bash

###
#       @author:lbergesio 
#       @organization: i2CAT
#       @project: OFELIA, FIBRE  FP7
#       @description: pre-upgrade-hook module  
###

#inform user
printHeader "info#" "Using specific 0.4 pre-upgrade-hook module..."

SRC_DIR=/opt/ofelia/vt_manager/

local TMP_PATH=$PWD

#Change permissions of the code 
printHeader ">" "Setting correct file permissions..."
chown -f $APACHE_USER $SRC_DIR/src/python/vt_manager/controller/policies/utils/log

# Installing pyPElib (if not previously installed or version not up to date)
pypelibUpToDate=`dpkg --get-selections | grep "pypelib" | grep "install"`
# 1st: install check
if [[ $pypelibUpToDate != "" ]]; then
    pypelibCurrentVersion=`sudo dpkg --list pypelib | awk '{for (i=1;i<=NF;i++) if (i==3) { print $i } }' | tail -n 1`
    sudo /usr/bin/wget https://pypelib.googlecode.com/git/VERSION -O pypelib.version.tmp
    pypelibLatestVersion=`cat pypelib.version.tmp`
    rm pypelib.version.tmp
    if [[ $pypelibCurrentVersion != $pypelibLatestVersion ]]; then
       $pypelibUpToDate=""
    fi
fi
# 2nd: up-to-date check
if [[ $pypelibUpToDate == "" ]]; then
    print "Downloading latest pypelib version..."
    /usr/bin/wget http://pypelib.googlecode.com/files/pypelib_latest_all.deb || error "Could not download pypelib latest version from http://pypelib.googlecode.com/files/pypelib_latest_all.deb. Do you have connectivity?"
    print "Installing pypelib_latest_all.deb..."
    /usr/bin/dpkg -i pypelib_latest_all.deb || error "Could not install pypelib latest version using /usr/bin/dpkg -i pypelib_latest_all.deb"
    print "Removing temporary files..."
    rm pypelib_latest_all.deb || "Could not remove pypelib_latest_all.deb"
fi

cd $TMP_PATH

